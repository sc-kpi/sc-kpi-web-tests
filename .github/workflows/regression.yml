name: Regression Tests

on:
  workflow_dispatch:
    inputs:
      suite:
        description: "Test suite to run"
        required: true
        default: smoke
        type: choice
        options:
          - smoke
          - regression
          - all
      web_branch:
        description: "sc-kpi-web branch to checkout & build"
        required: false
        default: develop
        type: string
      environment:
        description: "Config profile"
        required: true
        default: ci
        type: choice
        options:
          - ci
          - staging
      base_url:
        description: "Override base URL (skips web build if set)"
        required: false
        default: ""
        type: string
      api_branch:
        description: "sc-kpi-api branch to checkout & build"
        required: false
        default: develop
        type: string
      workers:
        description: "Playwright workers"
        required: true
        default: "2"
        type: choice
        options:
          - "1"
          - "2"
          - "4"
          - "6"
          - "8"
      rerun_failed:
        description: "Rerun only failed tests from a previous run"
        required: false
        default: false
        type: boolean
      previous_run_id:
        description: "Run ID to rerun failed tests from (required if rerun_failed=true)"
        required: false
        default: ""
        type: string
      caller_event:
        description: "Internal: event name from calling workflow"
        required: false
        default: ""
        type: string
      shards:
        description: "Number of parallel shards"
        required: true
        default: "1"
        type: choice
        options:
          - "1"
          - "2"
          - "4"

  workflow_call:
    inputs:
      suite:
        type: string
        required: true
        default: smoke
      web_branch:
        type: string
        required: false
        default: develop
      environment:
        type: string
        required: true
        default: ci
      base_url:
        type: string
        required: false
        default: ""
      api_branch:
        type: string
        required: false
        default: develop
      workers:
        type: string
        required: true
        default: "2"
      rerun_failed:
        type: boolean
        required: false
        default: false
      previous_run_id:
        type: string
        required: false
        default: ""
      caller_event:
        type: string
        required: false
        default: ""
      shards:
        type: string
        required: false
        default: "1"

concurrency:
  group: regression-${{ inputs.caller_event == 'schedule' && 'nightly' || github.run_id }}
  cancel-in-progress: false

permissions:
  contents: write
  pages: write
  id-token: write
  actions: read

jobs:
  build:
    name: Build applications
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: inputs.base_url == ''

    steps:
      - name: Checkout sc-kpi-web
        uses: actions/checkout@v4
        with:
          repository: sc-kpi/sc-kpi-web
          ref: ${{ inputs.web_branch }}
          path: sc-kpi-web

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: sc-kpi-web/pnpm-lock.yaml

      - name: Install sc-kpi-web dependencies
        working-directory: sc-kpi-web
        run: pnpm install --frozen-lockfile

      - name: Build sc-kpi-web
        working-directory: sc-kpi-web
        run: pnpm build

      - name: Copy static assets
        working-directory: sc-kpi-web
        run: |
          cp -r .next/static .next/standalone/.next/static
          if [ -d public ]; then cp -r public .next/standalone/public; fi

      - name: Package web build
        working-directory: sc-kpi-web
        run: tar czf web-build.tar.gz -C .next/standalone .

      - name: Upload web build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: sc-kpi-web/web-build.tar.gz
          retention-days: 1

      - name: Checkout sc-kpi-api
        uses: actions/checkout@v4
        with:
          repository: sc-kpi/sc-kpi-api
          ref: ${{ inputs.api_branch }}
          path: sc-kpi-api

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          java-version: 25
          distribution: temurin

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build API
        working-directory: sc-kpi-api
        run: ./gradlew :app:bootJar --no-daemon -x test

      - name: Upload API jar
        uses: actions/upload-artifact@v4
        with:
          name: api-jar
          path: sc-kpi-api/app/build/libs/sc-kpi-api.jar
          retention-days: 1

  prepare:
    name: Prepare shard matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      total: ${{ steps.matrix.outputs.total }}

    steps:
      - name: Generate shard matrix
        id: matrix
        run: |
          SHARDS=${{ inputs.rerun_failed == true && '1' || inputs.shards }}
          echo "matrix=$(python3 -c "import json; print(json.dumps(list(range(1, int('$SHARDS')+1))))")" >> "$GITHUB_OUTPUT"
          echo "total=$SHARDS" >> "$GITHUB_OUTPUT"

  test:
    name: "Test (shard ${{ matrix.shardIndex }}/${{ needs.prepare.outputs.total }})"
    needs: [build, prepare]
    if: always() && (needs.build.result == 'success' || needs.build.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        shardIndex: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - name: Checkout test repo
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install test dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps chromium

      - name: Install Playwright system deps
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps chromium

      - name: Download web build
        if: inputs.base_url == ''
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web-build

      - name: Start web app
        if: inputs.base_url == ''
        run: |
          tar xzf web-build/web-build.tar.gz -C web-build
          node web-build/server.js &

      - name: Wait for web app
        if: inputs.base_url == ''
        run: npx wait-on http://localhost:3000 --timeout 60000

      - name: Download API jar
        if: inputs.base_url == ''
        uses: actions/download-artifact@v4
        with:
          name: api-jar
          path: api-jar

      - name: Start MailPit
        if: inputs.base_url == ''
        run: |
          docker pull axllent/mailpit:v1.21
          docker run -d --name mailpit -p 1025:1025 -p 8025:8025 axllent/mailpit:v1.21

      - name: Wait for MailPit
        if: inputs.base_url == ''
        run: |
          timeout=120
          while [ $timeout -gt 0 ]; do
            if curl -sf http://localhost:8025 > /dev/null 2>&1; then
              echo "MailPit is ready"
              exit 0
            fi
            sleep 2
            timeout=$((timeout - 2))
          done
          echo "MailPit failed to start within 120 seconds"
          docker ps -a
          docker logs mailpit 2>&1 | tail -20
          exit 1

      - name: Setup Java 25
        if: inputs.base_url == ''
        uses: actions/setup-java@v4
        with:
          java-version: 25
          distribution: temurin

      - name: Start API
        if: inputs.base_url == ''
        run: java -jar api-jar/sc-kpi-api.jar --spring.profiles.active=dev > api.log 2>&1 &
        env:
          MAIL_HOST: localhost
          MAIL_PORT: "1025"
          GOOGLE_CLIENT_ID: test-client-id
          GOOGLE_CLIENT_SECRET: test-client-secret
          RATE_LIMIT_ENABLED: "false"
          LOGGING_LEVEL_UA_KPI_SC_AUTH: DEBUG

      - name: Wait for API
        if: inputs.base_url == ''
        run: npx wait-on http://localhost:8080/actuator/health --timeout 120000

      - name: Download previous last-run state
        if: inputs.rerun_failed == true && inputs.previous_run_id != '' && matrix.shardIndex == 1
        uses: actions/download-artifact@v4
        with:
          name: last-run-state
          path: .
          run-id: ${{ inputs.previous_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run E2E tests
        id: run-tests
        if: inputs.rerun_failed == false
        continue-on-error: true
        run: pnpm test:${{ inputs.suite }} --shard=${{ matrix.shardIndex }}/${{ needs.prepare.outputs.total }}
        env:
          TEST_ENV: ${{ inputs.environment }}
          CI: true
          WORKERS: ${{ inputs.workers }}
          BASE_URL: ${{ inputs.base_url || '' }}

      - name: Auto-retry failed tests
        id: auto-retry
        if: inputs.rerun_failed == false && steps.run-tests.outcome == 'failure'
        continue-on-error: true
        run: pnpm exec playwright test --last-failed
        env:
          TEST_ENV: ${{ inputs.environment }}
          CI: true
          WORKERS: ${{ inputs.workers }}
          BASE_URL: ${{ inputs.base_url || '' }}

      - name: Rerun failed tests (manual)
        id: manual-rerun
        if: inputs.rerun_failed == true
        continue-on-error: true
        run: |
          if [[ ! -f ".last-run.json" ]]; then
            echo "::error::.last-run.json not found."
            exit 1
          fi
          pnpm exec playwright test --last-failed
        env:
          TEST_ENV: ${{ inputs.environment }}
          CI: true
          WORKERS: ${{ inputs.workers }}
          BASE_URL: ${{ inputs.base_url || '' }}

      - name: Upload blob report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.shardIndex }}
          path: blob-report/
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.shardIndex }}
          path: allure-results/
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload last-run state
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: last-run-state-${{ matrix.shardIndex }}
          path: .last-run.json
          retention-days: 14
          if-no-files-found: ignore

      - name: Dump API logs on failure
        if: failure() && inputs.base_url == ''
        run: tail -300 api.log || echo "No API log file found"

      - name: Cleanup MailPit
        if: always()
        run: docker rm -f mailpit || true

  report:
    name: Report
    needs: [test, prepare]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout test repo
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download blob reports
        uses: actions/download-artifact@v4
        with:
          pattern: blob-report-*
          path: all-blob-reports
          merge-multiple: true
        continue-on-error: true

      - name: Merge HTML report
        id: merge-report
        continue-on-error: true
        run: |
          if ls all-blob-reports/*.zip 1>/dev/null 2>&1; then
            pnpm exec playwright merge-reports --reporter html ./all-blob-reports
          else
            echo "::warning::No blob reports found to merge"
          fi

      - name: Download Allure results
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-*
          path: allure-results
          merge-multiple: true
        continue-on-error: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Checkout gh-pages for Allure history
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Generate Allure report
        uses: simple-elf/allure-report-action@v1.13
        with:
          allure_results: allure-results
          allure_report: allure-report
          gh_pages: gh-pages
          allure_history: allure-history
          keep_reports: 50

      - name: Fix Allure report permissions
        run: sudo rm -rf allure-history/.git

      - name: Deploy Allure report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

      - name: Determine test outcome
        run: |
          if [[ "${{ needs.test.result }}" == "success" ]]; then
            echo "TEST_STATUS=PASSED" >> "$GITHUB_ENV"
          else
            echo "TEST_STATUS=FAILED" >> "$GITHUB_ENV"
          fi

      - name: Telegram notification
        if: always()
        run: |
          ALLURE_URL="https://sc-kpi.github.io/sc-kpi-web-tests/${{ github.run_number }}/"
          GITHUB_RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          SUMMARY_FILE="allure-report/widgets/summary.json"
          if [[ -f "$SUMMARY_FILE" ]]; then
            PASSED=$(jq -r '.statistic.passed // 0' "$SUMMARY_FILE")
            FAILED=$(jq -r '.statistic.failed // 0' "$SUMMARY_FILE")
            BROKEN=$(jq -r '.statistic.broken // 0' "$SUMMARY_FILE")
            SKIPPED=$(jq -r '.statistic.skipped // 0' "$SUMMARY_FILE")
            UNKNOWN=$(jq -r '.statistic.unknown // 0' "$SUMMARY_FILE")
            TOTAL=$(jq -r '.statistic.total // 0' "$SUMMARY_FILE")
            DURATION_MS=$(jq -r '.time.duration // 0 | floor' "$SUMMARY_FILE")
            TOTAL_SECS=$((DURATION_MS / 1000))
            HOURS=$((TOTAL_SECS / 3600))
            MINUTES=$(( (TOTAL_SECS % 3600) / 60 ))
            SECONDS=$((TOTAL_SECS % 60))
          else
            TOTAL=0; PASSED=0; FAILED=0; SKIPPED=0
            BROKEN=0; UNKNOWN=0
            HOURS=0; MINUTES=0; SECONDS=0
          fi

          SUITE_NAME="${{ inputs.suite }}"
          SUITE_DISPLAY="${SUITE_NAME^}"

          if [[ $TOTAL -eq 0 ]]; then
            STATUS="BROKEN"
            STATUS_ICON="üü°"
          elif [[ $((FAILED + BROKEN)) -gt 0 ]]; then
            STATUS="FAILED"
            STATUS_ICON="üî¥"
          else
            STATUS="PASSED"
            STATUS_ICON="üü¢"
          fi

          if [[ $TOTAL -gt 0 ]]; then
            PASS_RATE=$((PASSED * 100 / TOTAL))
            FILLED=$((PASS_RATE / 5))
          else
            PASS_RATE=0
            FILLED=0
          fi
          EMPTY=$((20 - FILLED))
          BAR=$(printf '‚ñà%.0s' $(seq 1 $FILLED 2>/dev/null))$(printf '‚ñë%.0s' $(seq 1 $EMPTY 2>/dev/null))

          WF_START=$(gh run view ${{ github.run_id }} --json createdAt -q '.createdAt')
          START_EPOCH=$(date -d "$WF_START" +%s)
          NOW_EPOCH=$(date +%s)
          WF_ELAPSED=$((NOW_EPOCH - START_EPOCH))
          WF_HOURS=$((WF_ELAPSED / 3600))
          WF_MINUTES=$(( (WF_ELAPSED % 3600) / 60 ))
          WF_SECONDS=$((WF_ELAPSED % 60))

          if [[ $HOURS -gt 0 ]]; then
            DURATION_FMT="${HOURS}h ${MINUTES}m ${SECONDS}s"
          else
            DURATION_FMT="${MINUTES}m ${SECONDS}s"
          fi

          if [[ $WF_HOURS -gt 0 ]]; then
            WF_TIME_FMT="${WF_HOURS}h ${WF_MINUTES}m ${WF_SECONDS}s"
          else
            WF_TIME_FMT="${WF_MINUTES}m ${WF_SECONDS}s"
          fi

          SETUP="‚Äî suite: ${{ inputs.suite }}"
          SETUP+=$'\n'"‚Äî web_branch: ${{ inputs.web_branch }}"
          SETUP+=$'\n'"‚Äî api_branch: ${{ inputs.api_branch }}"
          SETUP+=$'\n'"‚Äî environment: ${{ inputs.environment }}"
          SETUP+=$'\n'"‚Äî workers: ${{ inputs.workers }}"
          SETUP+=$'\n'"‚Äî shards: ${{ inputs.shards }}"
          SETUP+=$'\n'"‚Äî rerun_failed: ${{ inputs.rerun_failed }}"
          if [[ -n "${{ inputs.base_url }}" ]]; then
            SETUP+=$'\n'"‚Äî base_url: ${{ inputs.base_url }}"
          fi
          if [[ -n "${{ inputs.previous_run_id }}" ]]; then
            SETUP+=$'\n'"‚Äî previous_run_id: ${{ inputs.previous_run_id }}"
          fi

          RETRY_LINE="üîÑ  <b>Shards:</b> ${{ needs.prepare.outputs.total }}"

          ACTOR="${{ github.triggering_actor }}"
          CALLER_EVENT="${{ inputs.caller_event }}"
          EVENT="${{ github.event_name }}"
          if [[ "$EVENT" == "schedule" || "$CALLER_EVENT" == "schedule" ]]; then
            LAUNCHED_BY="üë§ <b>Launched by:</b> scheduled (nightly)"
          else
            LAUNCHED_BY="üë§ <b>Launched by:</b> <a href=\"https://github.com/${ACTOR}\">@${ACTOR}</a>"
          fi

          MESSAGE="‚∏ª‚∏ª‚∏ª‚∏ª‚∏ª
          <b>SC KPI WEB ${SUITE_DISPLAY} ‚Äî ${STATUS} ${STATUS_ICON}</b>

          <code>${BAR}</code>  ${PASS_RATE}% (${PASSED}/${TOTAL})

          <b>Suite:</b> ${SUITE_NAME}
          <b>Environment:</b> ${{ inputs.environment }}
          <b>Duration:</b> ${DURATION_FMT}
          <b>Workflow time:</b> ${WF_TIME_FMT}
          ‚∏ª‚∏ª‚∏ª‚∏ª‚∏ª
          ‚úÖ   Passed: <b>${PASSED}</b>
          ‚õîÔ∏è   Failed: <b>${FAILED}</b>
          ‚è≠Ô∏è   Skipped: <b>${SKIPPED}</b>
          ‚ö†Ô∏è   Broken: <b>${BROKEN}</b>
          ‚ÅâÔ∏è   Unknown: <b>${UNKNOWN}</b>

          ‚Äî <b>Total tests executed</b>: ${TOTAL}
          ${RETRY_LINE}
          ‚∏ª‚∏ª‚∏ª‚∏ª‚∏ª
          <b>Workflow setup:</b>
          ${SETUP}
          ‚∏ª‚∏ª‚∏ª‚∏ª‚∏ª
          üìä <a href=\"${ALLURE_URL}\">Allure Report</a>
          üîó <a href=\"${GITHUB_RUN_URL}\">GitHub Run</a>

          ${LAUNCHED_BY}
          ‚∏ª‚∏ª‚∏ª‚∏ª‚∏ª"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d message_thread_id="${TELEGRAM_TOPIC_ID}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview="true" \
            --data-urlencode "text=${MESSAGE}" || echo "::warning::Telegram notification failed"
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
          GH_TOKEN: ${{ github.token }}

      - name: Add Job Summary
        if: always()
        run: |
          REPORT_URL="https://sc-kpi.github.io/sc-kpi-web-tests/${{ github.run_number }}/"
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          ## Regression Test Results

          | Parameter | Value |
          |-----------|-------|
          | **Suite** | \`${{ inputs.suite }}\` |
          | **Environment** | \`${{ inputs.environment }}\` |
          | **Web Branch** | \`${{ inputs.web_branch }}\` |
          | **API Branch** | \`${{ inputs.api_branch }}\` |
          | **Base URL** | \`${{ inputs.base_url || 'http://localhost:3000 (local build)' }}\` |
          | **Workers** | \`${{ inputs.workers }}\` |
          | **Shards** | \`${{ inputs.shards }}\` |
          | **Allure Report** | ${REPORT_URL} |
          EOF
